<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <input type="text" id="search-user" placeholder="Search or start a new chat" oninput="searchUser()">
            </div>
            <div id="chat-list" class="chat-list">
                <!-- Chat items will be dynamically populated here -->
            </div>
        </div>
        <div class="main-chat">
            <div id="chat-header" class="chat-header">
                <h2 id="chat-recipient">Select a chat</h2>
            </div>
            <div id="chat-box" class="chat-box"></div>
            <div class="message-input">
                <input type="text" id="message" placeholder="Type a message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRecipientId = null;
        const currentUserId = {{ current_user.id }}; // Add current user ID
        const currentUsername = "{{ current_user.username }}"; // Add current username

        socket.on('message', function(data){
            if ((data.recipient === document.getElementById('chat-recipient').textContent) || 
                (data.author === document.getElementById('chat-recipient').textContent)) {
                addMessage(data.message, data.author, data.recipient, data.sender_id);
            } else if (data.recipient === currentUsername) {
                // Add notification indicator for new message
                const chatItem = document.querySelector(`.chat-item[data-username="${data.author}"]`);
                if (chatItem) {
                    const notification = chatItem.querySelector('.notification');
                    if (notification) {
                        notification.style.display = 'inline-block';
                    }
                }
            }
        });

        document.addEventListener("DOMContentLoaded", function(){
            loadChatList();
        });

        function loadChatList() {
            fetch('/users')
                .then(response => response.json())
                .then(users => {
                    const chatList = document.getElementById('chat-list');
                    chatList.innerHTML = '';
                    users.forEach(user => {
                        if (user.username !== currentUsername) { // Filter out the current user
                            const chatItem = document.createElement('div');
                            chatItem.className = 'chat-item';
                            chatItem.setAttribute('data-username', user.username); // Set username attribute
                            chatItem.innerHTML = `${user.username} <span class="notification"></span>`;
                            chatItem.onclick = () => loadChat(user.id, user.username, chatItem);
                            chatList.appendChild(chatItem);
                        }
                    });
                });
        }

        function loadChat(recipientId, recipientName, chatItem) {
            currentRecipientId = recipientId;
            document.getElementById('chat-recipient').textContent = recipientName;

            // Remove active class from all chat items
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));

            // Add active class to the selected chat item
            chatItem.classList.add('active');

            // Remove notification indicator for selected chat item
            const notification = chatItem.querySelector('.notification');
            if (notification) {
                notification.style.display = 'none';
            }

            fetch(`/messages?recipient_id=${recipientId}`)
                .then(response => response.json())
                .then(messages => {
                    const chatBox = document.getElementById('chat-box');
                    chatBox.innerHTML = '';
                    messages.forEach(msg => addMessage(msg.content, msg.author, msg.recipient, msg.sender_id));
                });
        }

        function addMessage(msg, author, recipient, senderId) {
            let chatBox = document.getElementById('chat-box');
            let messageElement = document.createElement('div');
            // Add class based on sender_id to determine alignment
            messageElement.className = senderId === currentUserId ? 'message sent' : 'message received';
            messageElement.innerHTML = `
                <span class="message-content" data-original="${msg}">${msg}</span>
                <select class="translate-dropdown" onchange="translateMessage(this)">
                    <option value="">Translate</option>
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="zh-cn">Chinese</option>
                </select>
            `;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendMessage() {
            let recipient = document.getElementById('chat-recipient').textContent;
            let messageInput = document.getElementById('message');
            let message = messageInput.value;
            socket.emit('message', {recipient: recipient, message: message});
            messageInput.value = '';
        }

        function translateMessage(selectElement) {
            let messageElement = selectElement.previousElementSibling;
            let originalText = messageElement.getAttribute('data-original');
            let dest_lang = selectElement.value;

            // Extract the actual message content
            let textToTranslate = dest_lang === 'en' ? originalText : messageElement.textContent;

            fetch('/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({text: textToTranslate, dest_lang: dest_lang})
            })
            .then(response => response.json())
            .then(data => {
                messageElement.textContent = data.translated_text;
            });
        }

        function searchUser() {
            let searchInput = document.getElementById('search-user').value;
            let chatItems = document.querySelectorAll('.chat-item');
            chatItems.forEach(item => {
                if (item.textContent.toLowerCase().includes(searchInput.toLowerCase())) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
