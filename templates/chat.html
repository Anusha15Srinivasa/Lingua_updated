<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <input type="text" id="search-user" placeholder="Search or start a new chat" oninput="searchUser()">
            </div>
            <div id="chat-list" class="chat-list">
                {% for user in users %}
                <div class="chat-item" onclick="loadChat({{ user.id }}, '{{ user.username|e|replace("'", "\\'") }}')">{{ user.username }}</div>
                {% endfor %}
            </div>
        </div>
        <div class="main-chat">
            <div id="chat-header" class="chat-header">
                <h2 id="chat-recipient">Select a chat</h2>
            </div>
            <div id="chat-box" class="chat-box"></div>
            <div class="message-input">
                <input type="text" id="message" placeholder="Type a message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRecipientId = null;

        socket.on('message', function(data){
            if ((data.recipient === document.getElementById('chat-recipient').textContent) || 
                (data.author === document.getElementById('chat-recipient').textContent)) {
                addMessage(data.message, data.author, data.recipient);
            }
        });

        document.addEventListener("DOMContentLoaded", function(){
            loadChatList();
        });

        function loadChatList() {
            fetch('/messages')
                .then(response => response.json())
                .then(data => {
                    const chatList = document.getElementById('chat-list');
                    chatList.innerHTML = '';
                    const groupedMessages = groupMessagesByRecipient(data);
                    for (const recipient in groupedMessages) {
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-item';
                        chatItem.textContent = recipient;
                        chatItem.onclick = () => loadChat(groupedMessages[recipient][0].recipient_id, recipient);
                        chatList.appendChild(chatItem);
                    }
                });
        }

        function groupMessagesByRecipient(messages) {
            return messages.reduce((groups, message) => {
                const key = message.recipient === current_user ? message.author : message.recipient;
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(message);
                return groups;
            }, {});
        }

        function loadChat(recipientId, recipientName) {
            currentRecipientId = recipientId;
            document.getElementById('chat-recipient').textContent = recipientName;
            fetch(`/messages?recipient_id=${recipientId}`)
                .then(response => response.json())
                .then(messages => {
                    const chatBox = document.getElementById('chat-box');
                    chatBox.innerHTML = '';
                    messages.forEach(msg => addMessage(msg.content, msg.author, msg.recipient));
                });
        }

        function addMessage(msg, author, recipient) {
            let chatBox = document.getElementById('chat-box');
            let messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
                <span class="message-content" data-original="${msg}">${author} to ${recipient}: ${msg}</span>
                <select class="translate-dropdown" onchange="translateMessage(this)">
                    <option value="">Translate</option>
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="zh-cn">Chinese</option>
                    <!-- Add more languages as needed -->
                </select>
            `;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendMessage() {
            let recipient = document.getElementById('chat-recipient').textContent;
            let messageInput = document.getElementById('message');
            let message = messageInput.value;
            socket.emit('message', {recipient: recipient, message: message});
            messageInput.value = '';
        }

        function translateMessage(selectElement) {
            let messageElement = selectElement.previousElementSibling;
            let originalText = messageElement.getAttribute('data-original');
            let dest_lang = selectElement.value;

            // Extract the actual message content
            let messageParts = messageElement.textContent.split(': ');
            let header = messageParts[0] + ': ';

            let textToTranslate = dest_lang === 'en' ? originalText : messageParts[1];

            fetch('/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({text: textToTranslate, dest_lang: dest_lang})
            })
            .then(response => response.json())
            .then(data => {
                messageElement.textContent = header + data.translated_text;
            });
        }

        function searchUser() {
            let searchInput = document.getElementById('search-user').value;
            fetch(`/search_users?query=${searchInput}`)
                .then(response => response.json())
                .then(users => {
                    const chatList = document.getElementById('chat-list');
                    chatList.innerHTML = '';
                    users.forEach(user => {
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-item';
                        chatItem.textContent = user.username;
                        chatItem.onclick = () => loadChat(user.id, user.username);
                        chatList.appendChild(chatItem);
                    });
                });
        }
    </script>
</body>
</html>
